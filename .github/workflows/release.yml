name: Release

on:
  push:
    tags:
      - "v*.*.*" # Triggers on tags like v1.0.0

jobs:
  release:

    strategy:
      # https://gist.github.com/asukakenji/f15ba7e588ac42795f421b48b8aede63
      matrix:
        arch: [amd64, arm64, 386]
        os: [linux, darwin]
        include:
          - os: linux
            runs_on: ubuntu-latest
          - os: darwin
            runs_on: macos-latest

        exclude:
          - os: linux
            arch: arm64
          - os: darwin
            arch: 386


    runs-on: ${{ matrix.runs_on }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        lfs: true
        fetch-depth: 0

    - name: Set Release Version
      shell: bash
      run: |
        ver=${GITHUB_REF##*/}
        if [[ ! "$ver" =~ ^v[0-9]+(\.[0-9]+){2}(-rc[0-9]+)?$ ]]; then
          echo "Error: Tag format is invalid. Expected format: vX.X.X or vX.X.X-rcX"
          exit 1
        fi

        echo "RELEASE_VERSION=$ver" >> $GITHUB_ENV

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'

    # - name: debug env
    #   run: |
    #     echo "${{ toJSON(env) }}"
    #     echo "${{ toJSON(github) }}"
    #     echo "${{ toJSON(jobs) }}"


    #- name: Setup Cross-Compile
    #  if: "${{ matrix.arch == 'arm64' }}"
    #  run: |
    #    set -euxo pipefail
    #    apt-get install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
    #    env CC=aarch64-linux-gnu-gcc CXX=aarch64-linux-gnu-g++ CGO_ENABLED=1 GOOS=linux GOARCH=arm64
      #
    - name: Dependencies linux
      if: ${{ matrix.os == 'linux' }}
      run: |
        sudo apt install -y build-essential

    - name: Dependencies linux 386
      if: ${{ matrix.os == 'linux' && matrix.arch == '386' }}
      run: |
          sudo apt install -y gcc-multilib g++-multilib

    - name: Build
      run: |
        set -euxo pipefail

        make genimports
        export CGO_ENABLED=1
        export GOARCH="${{ matrix.arch }}"

        case "${{ matrix.os }}" in
          darwin)
            make SYSTRAY=true bundle-macos
            ;;
          linux)
            make SYSTRAY=true release
            ;;
          *)
            echo "Unsupported OS: ${{ matrix.os }}"
            exit 1
            ;;
        esac


    - name: Prepare package archive
      id: package
      env:
        version: ${{ env.RELEASE_VERSION }}
      run: |
        set -euxo pipefail

        # echo "version=${{ steps.check-tag.outputs.version }}"
        # echo "rc=${{ steps.check-tag.outputs.rc }}"

        bin=${GITHUB_REPOSITORY##*/}
        dist_dir=`pwd`/dist
        name=$bin-$version-${{ matrix.os }}-${{ matrix.arch }}
        echo "RELEASE_NAME=$name" >> $GITHUB_ENV

        mkdir -p $dist_dir/$bin-$version

        cp -a build/* {LICENSE,README.md} $dist_dir/$bin-$version
        echo "dist_dir=$dist_dir" >> $GITHUB_OUTPUT

        cd $dist_dir

        archive=$dist_dir/$name.tar.gz
        tar -czf $archive *
        echo "archive=dist/$name.tar.gz" >> $GITHUB_OUTPUT

    # - name: (testing) Upload release assets
    #   uses: https://gitea.com/actions/gitea-upload-artifact@v4
    #   with:
    #     name: ${{ env.RELEASE_NAME }}
    #     path: dist/*
  
    # - name: debug env
    #   run: echo 

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: github.ref_type == 'tag'
      with:
        name: Release ${{ env.RELEASE_VERSION }}
        # body: |
        #   Automated release from CI
        draft: true
        prerelease: false
        generate_release_notes: true
        token: ${{ secrets.GITHUB_TOKEN }}
        files: |
          ${{ steps.package.outputs.archive }}

    # # Cross-platform build (uncomment to use):
    # - name: Cross-platform builds
    #   strategy:
    #     matrix:
    #       goos: [linux, windows, darwin]
    #       goarch: [amd64, 386, arm64]
    #   runs-on: ubuntu-latest
    #   steps:
    #     - name: Set GOOS/GOARCH
    #       run: |
    #         echo "GOOS=${{ matrix.goos }}" >> $GITHUB_ENV
    #         echo "GOARCH=${{ matrix.goarch }}" >> $GITHUB_ENV
    #     - name: Build
    #       run: make release
    #     - name: Package
    #       run: make dist
    #     - name: Upload artifact
    #       uses: actions/upload-artifact@v4
    #       with:
    #         name: release-assets-${{ matrix.goos }}-${{ matrix.goarch }}
    #         path: dist/*.tar.gz
